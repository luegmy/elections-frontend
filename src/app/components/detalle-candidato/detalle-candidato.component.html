<div class="detalle-container" *ngIf="candidate">
  <div class="top-header-ultra-compact">
    <div class="header-left-side">
      <button (click)="goBack()" class="btn-back-smart">← Volver</button>
      <div class="candidate-main-info">
        <h1 class="candidate-name">{{ candidate?.name }}</h1>
        <p class="candidate-party-text">{{ candidate?.party }}</p>
      </div>
    </div>
    
    <div class="header-right-meta">
      <img [src]="candidate?.partyAcronym" alt="Logo" class="candidate-logo-detail">
      <div class="level-pill" [ngClass]="'level-' + candidate?.rankingLevel">
        <span class="lvl-label">NIVEL</span>
        <span class="lvl-num">{{ candidate?.rankingLevel }}</span>
      </div>
    </div>
  </div>

  <div id="anchor-top" style="scroll-margin-top: 150px;"></div>

  <div class="nav-scores-container">
    <div class="scores-group side">
      <div class="score-card-mini" [ngClass]="getScoreClass(candidate?.scores?.judicialScore)" (click)="scrollToSection('judicial')">
        <span class="s-label">INTEGRIDAD</span>
        <span class="s-val">{{ candidate?.scores?.judicialScore | number:'1.1-1' }}</span>
      </div>
      <div class="score-card-mini" [ngClass]="getScoreClass(candidate?.scores?.contributionScore)" (click)="scrollToSection('logros')">
        <span class="s-label">APORTES</span>
        <span class="s-val">{{ candidate?.scores?.contributionScore | number:'1.1-1' }}</span>
      </div>
    </div>

    <div class="scores-group-center">
      <div class="score-card-main" [ngClass]="getScoreClass(candidate?.scores?.planScore)" (click)="scrollToSection('propuestas')">
        <span class="s-label">PLAN DE GOBIERNO</span>
        <span class="s-val">{{ candidate?.scores?.planScore | number:'1.1-1' }}</span>
      </div>
      <div class="score-card-main" [ngClass]="getScoreClass(candidate?.scores?.finalScore)">
        <span class="s-label">GLOBAL</span>
        <span class="s-val">{{ candidate?.scores?.finalScore | number:'1.1-1' }}</span>
      </div>
    </div>

    <div class="scores-group side">
      <div class="score-card-mini" [ngClass]="getScoreClass(candidate?.scores?.transparencyScore)" (click)="scrollToSection('transparencia')">
        <span class="s-label">TRANSPARENCIA</span>
        <span class="s-val">{{ candidate?.scores?.transparencyScore | number:'1.1-1' }}</span>
      </div>
      <div class="score-card-mini" [ngClass]="getScoreClass(candidate?.scores?.trustScore)" (click)="scrollToSection('confianza')">
        <span class="s-label">CONFIANZA</span>
        <span class="s-val">{{ candidate?.scores?.trustScore | number:'1.1-1' }}</span>
      </div>
    </div>
  </div>

  <div class="content-body-spacer">
    <section class="section-box" id="judicial">
      <h2 class="section-title-return" (click)="scrollToSection('anchor-top')">HISTORIAL JUDICIAL ▲</h2>
      <div *ngFor="let h of candidate?.history; let i = index" 
           class="legal-card" 
           [ngClass]="getSeverityClass(h.severity)">
        <div class="legal-header" (click)="toggleItem(expandedHistory, i)">
          <div class="header-left">
            <span class="sev-dot" [ngClass]="getSeverityBg(h.severity)"></span>
            <span class="legal-title">{{ h.title }}</span>
          </div>
          <div class="header-right">
            <span class="verified-pill" *ngIf="h.verified">VERIFICADO</span>
            <span class="chevron">{{ expandedHistory.get(i) ? '−' : '+' }}</span>
          </div>
        </div>
        <div class="legal-body" *ngIf="expandedHistory.get(i)">
          <p class="legal-desc">{{ h.description }}</p>
          <div class="legal-data-grid">
            <div class="tech-row"><span>Estado:</span> {{ h.status }}</div>
            <div class="tech-row"><span>Expediente:</span> {{ h.expedientNumber }}</div>
            <div class="tech-row"><span>Fuente:</span> {{ h.source }}</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section-box" id="logros">
      <h2 class="section-title-return" (click)="scrollToSection('anchor-top')">LOGROS Y APORTES ▲</h2>
      <div class="achievements-container">
        <div *ngFor="let a of candidate?.achievements" class="achievement-item-smart" 
             [ngClass]="{'border-red': a.impactScore < 0, 'border-green': a.impactScore >= 0}">
          <div class="achievement-main">
            <span class="impact-icon" [ngClass]="a.impactScore < 0 ? 'text-red' : 'text-green'">
              {{ a.impactScore < 0 ? '▼' : '▲' }}
            </span>
            <div class="achievement-info">
              <p class="achievement-desc-text">{{ a.description }}</p>
              <div class="achievement-meta">
                <span class="verified-text" *ngIf="a.verified">✔ Verificado</span>
                <a *ngIf="a.sourceUrl" [href]="a.sourceUrl" target="_blank" class="source-link-mini">Fuente</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="compact-dual-grid">
      <div class="data-card" id="transparencia">
        <h2 class="section-title-return" style="margin-top: 0; margin-bottom: 10px;" (click)="scrollToSection('anchor-top')">TRANSPARENCIA ▲</h2>
        <div class="row">
          <span>Hoja de Vida:</span> 
          <span [ngClass]="candidate?.transparency?.submittedDeclaration ? 'text-green' : 'text-red'">
            {{ candidate?.transparency?.submittedDeclaration ? '✔' : '✘' }}
          </span>
        </div>
        <div class="row clickable" (click)="showExtra = !showExtra">
          <span>Inconsistencias:</span> 
          <span [class.text-red]="candidate?.transparency?.declarationInconsistencies > 0">
            {{ candidate?.transparency?.declarationInconsistencies }} 
            <small *ngIf="candidate?.transparency?.inconsistencyDetails?.length"> (ver ▼)</small>
          </span>
        </div>
        <div class="extra-detail-box" *ngIf="showExtra && candidate?.transparency?.inconsistencyDetails?.length">
          <ul>
            <li *ngFor="let detail of candidate?.transparency?.inconsistencyDetails">{{ detail }}</li>
          </ul>
        </div>
        <div class="row">
          <span>Funcionario:</span> 
          <span class="text-white">{{ candidate?.transparency?.wasPublicOfficer ? 'SÍ' : 'NO' }}</span>
        </div>
        <div class="row" *ngIf="candidate?.transparency?.wasPublicOfficer">
          <span>Asistencia:</span> 
          <span [ngClass]="candidate?.transparency?.attendancePercentage > 80 ? 'text-green' : 'text-red'">
            {{ candidate?.transparency?.attendancePercentage }}%
          </span>
        </div>
        <div class="row">
          <span>Ingresos/Egresos:</span> 
          <span>
            <span [ngClass]="candidate?.transparency?.publishedIncome ? 'text-green' : 'text-red'">{{ candidate?.transparency?.publishedIncome ? '✔' : '✘' }}</span> /
            <span [ngClass]="candidate?.transparency?.publishedExpenses ? 'text-green' : 'text-red'">{{ candidate?.transparency?.publishedExpenses ? '✔' : '✘' }}</span>
          </span>
        </div>
        <div class="audit-note" *ngIf="candidate?.transparency?.economicAuditNotes">
          <small>Nota Contraloría: {{ candidate?.transparency?.economicAuditNotes }}</small>
        </div>
      </div>

      <div class="data-card" id="confianza">
        <h2 class="section-title-return" style="margin-top: 0; margin-bottom: 10px;" (click)="scrollToSection('anchor-top')">CONFIANZA ▲</h2>
        <div class="row clickable" (click)="showSanctions = !showSanctions">
          <span>Sanciones (M/m):</span> 
          <span [class.text-red]="candidate?.trust?.majorSanctions > 0">
            {{ candidate?.trust?.majorSanctions }} / {{ candidate?.trust?.minorSanctions }}
            <small *ngIf="candidate?.trust?.sanctionsDetail"> (ver detalle ▼)</small>
          </span>
        </div>
        <div class="extra-detail-box" *ngIf="showSanctions && candidate?.trust?.sanctionsDetail">
          <div *ngFor="let entry of candidate.trust.sanctionsDetail | keyvalue" class="sanction-group">
            <div class="sanction-category">{{ entry.key }}:</div>
            <ul>
              <li *ngFor="let item of $any(entry.value)">{{ item }}</li>
            </ul>
          </div>
        </div>
        <div class="row">
          <span>Cambios Partido:</span> 
          <span [ngClass]="candidate?.trust?.partySwitches > 2 ? 'text-red' : 'text-purple'">
            {{ candidate?.trust?.partySwitches }}
          </span>
        </div>
        <div class="row clickable" (click)="showFactCheck = !showFactCheck">
          <span>Fact-Check:</span> 
          <span [class.text-red]="candidate?.trust?.factCheckFailures > 0">
            {{ candidate?.trust?.factCheckFailures }}
            <small *ngIf="candidate?.trust?.factCheckSources?.length"> (fuentes ▼)</small>
          </span>
        </div>
        <div class="extra-detail-box" *ngIf="showFactCheck && candidate?.trust?.factCheckSources?.length">
          <div *ngFor="let s of candidate?.trust?.factCheckSources" class="source-link">
             <small>• {{ s }}</small>
          </div>
        </div>
        <div class="row">
          <span>Sanción Ética:</span> 
          <span [ngClass]="!candidate?.trust?.ethicsSanction ? 'text-green' : 'text-red'">
            {{ candidate?.trust?.ethicsSanction ? 'SÍ (✘)' : 'NINGUNA (✔)' }}
          </span>
        </div>
      </div>
    </div>

    <section class="section-box" id="propuestas">
      <div class="section-header-flex">
        <h2 class="section-title-return" (click)="scrollToSection('anchor-top')">PLAN DE GOBIERNO ▲</h2>
        <a *ngIf="candidate.governmentPlan?.documentUrl" [href]="candidate.governmentPlan.documentUrl" target="_blank" class="pdf-link-btn">PDF OFICIAL</a>
      </div>
      <div *ngFor="let p of candidate.governmentPlan?.proposals; let i = index" class="proposal-card">
        <div class="proposal-header" (click)="toggleItem(expandedProposals, i)">
          <div class="header-left">
            <span class="area-tag">{{ p.area }}</span>
            <span class="proposal-title">{{ p.title }}</span>
          </div>
          <span class="chevron">{{ expandedProposals.get(i) ? '−' : '+' }}</span>
        </div>
        <div class="proposal-body" *ngIf="expandedProposals.get(i)">
          <div class="source-info">FUENTE: {{ p.sourcePlan }}</div>
          <p class="proposal-desc">{{ p.detailDescription }}</p>
          <div class="proposal-two-columns">
            <div class="p-col">
              <div class="stat-item">
                <span class="s-label-tech">Viabilidad: {{ (p.feasibilityScore * 100) | number:'1.0-0' }}%</span>
                <div class="bar-container">
                  <div class="bar-fill" [style.width.%]="p.feasibilityScore * 100"></div>
                </div>
              </div>
              <div class="stat-item">
                <span class="s-label-tech">Impacto: {{ (p.impactScore * 100) | number:'1.0-0' }}%</span>
                <div class="bar-container">
                  <div class="bar-fill impact" [style.width.%]="p.impactScore * 100"></div>
                </div>
              </div>
            </div>
            <div class="p-col tech-data">
              <div class="tech-row"><span>Costo:</span> {{ p.costEstimate }}</div>
              <div class="tech-row" [class.text-red]="p.requiresConstitutionalReform">
                <span>Reforma:</span> {{ p.requiresConstitutionalReform ? 'SÍ' : 'NO' }}
              </div>
              <div class="tech-row" [class.text-red]="p.violatesInternationalTreaties">
                <span>Tratados:</span> {{ p.violatesInternationalTreaties ? 'VULNERA' : 'RESPETA' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>